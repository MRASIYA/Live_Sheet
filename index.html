<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Daily Counting</title>
<style>
  body { font-family: Arial; max-width:800px; margin:20px auto; }
  label, select, input { display:block; margin:10px 0; width:100%; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th,td { border:1px solid #ccc; padding:8px; text-align:center; }
  th { background:#3498db; color:white; }
  button { margin-right:10px; padding:8px 12px; cursor:pointer; }
  #message { margin-top:10px; font-weight:bold; }
</style>
</head>
<body>
<h1>Daily Counting</h1>
<label>Material Name:</label>
<select id="materialName"></select>

<label>Type:</label>
<select id="typeSelect">
  <option value="Received">Received</option>
  <option value="Issued">Issued</option>
  <option value="Return">Return</option>
</select>

<label>Quantity:</label>
<input type="number" id="quantity" value="1" min="1" />

<button id="addBtn">Add Quantity</button>
<button id="clearBtn">Clear All</button>
<button id="downloadBtn">Download Excel</button>

<div id="message"></div>

<h2>Material Summary</h2>
<table>
  <thead><tr><th>Material</th><th>Received</th><th>Issued</th><th>Return</th></tr></thead>
  <tbody id="summaryBody"></tbody>
</table>

<script>
const baseUrl = 'https://script.google.com/macros/s/AKfycbyqiuKArcANAmOeYkHmdzd8iNLKGCXaH22nryH-lws8HxVB8l4URC5N8MYVoEA6ilCv/exec';  

async function fetchMaterials(){
  const res = await fetch(`${baseUrl}?action=getMaterialNames`);
  const arr = await res.json();
  const sel = document.getElementById('materialName');
  sel.innerHTML = '';
  arr.forEach(m=> {
    const opt = document.createElement('option');
    opt.value = opt.textContent = m;
    sel.appendChild(opt);
  });
}

async function fetchSummary(){
  const res = await fetch(`${baseUrl}?action=getSummaryData`);
  const arr = await res.json();
  const tbody = document.getElementById('summaryBody');
  tbody.innerHTML = '';
  arr.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.material}</td><td>${r.received}</td><td>${r.issued}</td><td>${r.returned}</td>`;
    tbody.appendChild(tr);
  });
}

function showMsg(msg, err=false){
  const d=document.getElementById('message');
  d.textContent=msg;
  d.style.color=err?'red':'green';
}

async function addQty(){
  const material = document.getElementById('materialName').value;
  const type = document.getElementById('typeSelect').value;
  const quantity = Number(document.getElementById('quantity').value);
  if (!material) { showMsg('Select material first', true); return; }
  if (!quantity || quantity<=0) { showMsg('Enter valid quantity', true); return; }

  const res = await fetch(baseUrl,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'addQuantity', materialName:material, type, quantity})
  });
  const json = await res.json();
  showMsg(json.message, !json.success);
  fetchSummary();
}

async function clearAll(){
  if (!confirm('Clear all data?')) return;
  const res = await fetch(baseUrl,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action:'clearFGH'})
  });
  const json = await res.json();
  showMsg(json.message, !json.success);
  fetchSummary();
}

async function downloadExcel(){
  const res = await fetch(`${baseUrl}?action=getExcelFile`);
  const obj = await res.json();
  if (obj.url) window.open(obj.url,'_blank');
  else showMsg('Excel link unavailable', true);
}

document.getElementById('addBtn').onclick = addQty;
document.getElementById('clearBtn').onclick = clearAll;
document.getElementById('downloadBtn').onclick = downloadExcel;

window.onload = () => {
  fetchMaterials();
  fetchSummary();
};
</script>
</body>
</html>
